<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Landing version 1.2.1.1, modern ui and colour, te reo translation, https://codepen.io/Amorangi-Mathews/pen/yyYMrwP to create te reo tags, added 1.3.1.7 with updated button  -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Region warning and alerts (beta)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #dc3545;
      --secondary: #3a3d42;
      --background: #f4f6f8;
      --light: #ffffff;
      --left1: #4b90d3;
    }

    .inline-translate {font-style: italic;}

   
    
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--background);
      color: var(--secondary);
      line-height: 1.6;
    }

    header {
      background: linear-gradient(to right, #dc3545, #ff6b6b);
      color: var(--light);
      text-align: center;
      padding: 4rem 1rem 2rem;
    }

    header h1 {
      margin: 0;
      font-size: 2.5rem;
    }

    header p {
      margin-top: 0.5rem;
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .hero-icon {
      width: 80px;
      height: 80px;
      margin: 1rem auto;
      fill: white;
      opacity: 0.9;
    }

    main {
      padding: 2rem 1rem;
      max-width: 960px;
      margin: auto;
    }

    section {
      background: var(--light);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    section h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: var(--secondary);
    }

    footer {
      text-align: center;
      font-size: 0.9rem;
      color: #777;
      padding: 2rem 1rem;
    }

    a.button {
      display: inline-block;
      background-color: var(--primary);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      text-decoration: none;
      margin-top: 1rem;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    a.button:hover {
      background-color: #b02a37;
    }

    .feature-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .feature {
      background: #fefefe;
      border-radius: 10px;
      padding: 1rem;
      border-left: 5px solid var(--left1);
    }

    .feature h3 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .feature svg {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 0.4rem;
      fill: var(--primary);
    }
  </style>

      <style>
    .alert-card {
      background: #fff0f0;
      border-left: 5px solid #ffa500;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 6px;
    }
    .far-north {
      border-left-color: #dc3545;
      /* background: #fff0f0; */
    }

    /* Floating alerts window and toggle icon */
    #floating-alerts-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 450px;
      max-height: 70vh;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      background: #FFFFFF;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border-left: 4px solid #FFFFFF;
      border-radius: 8px;
      padding: 1rem;
          font-size: 13.8px;
    line-height: normal;
    }

    #toggle-alerts-btn {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 48px;
      height: 48px;
      background: #ffcc00;
          background: linear-gradient(to right, #ffeb00, #ed0017);
    border-radius: 50%;
    background: #ffcc00;
          background: linear-gradient(to right, #ed0017, #ed0017);
    border-radius: 50%;
    /*border: black;
    border-style: solid;
      border-width: thin;*/
        border-style: solid;
  border-width: medium;
  border-color: #750000;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      font-size: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
    }

    #toggle-alerts-btn:hover {
      background: #ffaa00;
      background: linear-gradient(to right, #ffeb00, #ed0017);
    }
    
    @media (max-width: 600px) {
  #floating-alerts-container {
    width: 90vw;
    right: 0.5rem;
    left: 0.5rem;
    bottom: 4rem;
    max-height: 60vh;
    border-left-width: 3px;
    font-size: 0.95em;
        font-size: 13.8px;
    line-height: normal;
  }}

/* first badge work*/

.badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.8em;
  margin-top: 4px;
}

.active-now {
 /*  border-left-color: #e53935 !important;
  background: #ffeaea;  */
}

.upcoming {
/*  border-left-color: #0288d1 !important;
  background: #e3f2fd; */
}

.active-badge {
  background: #e53935;
  color: white;
}

.upcoming-badge {
  background: #e53935;
  color: white;
}
/* Default fallback */
.alert-default {
  border-left-color: #ffa500;
  background: #fffaf0;
}

.alert-orange {
  border-left-color: #FF8918;
  background: #fff3e0;
}
 
.alert-red {
  border-left-color: #d32f2f;
  background: #fdecea;
}

.alert-cd {
  border-left-color: #d32f2f;
  background: #123c59;
      border: solid;
    border-width: thin;
    border-color: #fffc38;
}

    
    
.alert-yellow {
  border-left-color: #fbc02d;
  background: #fffde7;
}

.alert-green {
  border-left-color: #388e3c;
  background: #e8f5e9;
}

/* Badge styles */
.badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.8em;
  margin-top: 4px;
  font-weight: 600;
  color: white;
}

    .badge.alert-met {background: #172344;}   
.badge.alert-orange { background: #FF8918; border: solid; border-width: thin; border-color: #000000; }
.badge.alert-red { background: #d32f2f;  border: solid; border-width: thin;    border-color: #000000;}
.badge.alert-yellow { background: #fbc02d; color: black;  border: solid; border-width: thin; border-color: #000000;}
.badge.alert-cd {color: white; }
.badge.alert-green { background: #388e3c; }

.active-now {
  /* optional override styles */
}

.upcoming {
  /* optional override styles */
}

    .expired-badge {
  background: #464951;
  color: white;
       border: solid;
    border-width: thin;
    border-color: #000000;
}
    /*style for initial header and footer*/
.alert-header {
    background: #868687;
    margin-bottom: 1rem;
    color: #000000;
  border-radius: 10px;
    padding: 10px 10px 10px 10px;
  /*  font-size: 14.2px; 
    line-height: 1.4;*/
     
}
.alert-header hr {
  border: none;
  border-top: 1px solid #ddd;
  margin-top: 0.5rem;
}
    .alert-footer {
  margin-top: 1rem;
  /*font-size: 12.2px;*/
 background: #868687;
    margin-bottom: 1rem;
    color: #000000;
  border-radius: 10px;
    padding: 10px 1px 10px 10px;
  line-height: 1.4;
}
.alert-footer a {
  color: #004d99;
  text-decoration: underline;
}
.alert-footer hr {
  border: none;
  border-top: 1px solid #ddd;
  margin-top: 1rem;
  
}
  </style>

<style>
/*style for modern header and footer*/
.alert-header {
  background: linear-gradient(to right, #dc3545, #dc3545);
  color: white;
  border-style: solid;
  border-width: medium;
  border-color: #750000;
  padding: 0.75rem 1rem;
  border-radius: 8px 8px 0 0;
  /*font-size: 1rem;
  font-weight: 600;*/
  line-height: 1.4;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.alert-header em {
  font-style: normal;
  font-weight: 400;
  opacity: 0.95;
}

.alert-footer {
  background: #f4f6f8;
  border-top: 1px solid #e0e0e0;
  padding: 0.75rem 1rem;
  border-radius: 0 0 8px 8px;
  /*font-size: 0.85rem;
  color: #555;*/
  text-align: left;
  margin-top: 1rem;
}

.alert-footer a {
  color: #dc3545;
  text-decoration: none;
  font-weight: 500;
}

.alert-footer a:hover {
  text-decoration: underline;
}
</style>
<style>
/*cancelled badge for cd alerts*/
.cancelled-badge {
  background: #616161;
  color: white;
   border: solid;
    border-width: thin;
    border-color: #000000;
}
</style>

  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
</head>
<body> 
 
<!-- Floating Alerts UI -->
<div id="floating-alerts-container"></div>
<button id="toggle-alerts-btn" title="Weather Alerts">⛈️</button>

  <script>


</script>
  
<script>
  //version and current functionality
  const version = "1.3.1.7";
  let lastUpdatedTime = new Date();
  const functions = "Alert display, Container, Popup, onset window, non far north display, isstillactivecolour classes, simpilfy, cachefix, expiry tag, sorted, expiry hide, CD alerts added, sorting, badges, formatted alrert for cd, custom geo area with proxy and url support,  newgeojsonurl, temp urls for cd and met, area name extraction and apply to alert html,disable far north alerts, custom new geo json url. area definitions , html edit (msgType removed), multi area in alert html with and for multi location, custom sorted custom area,popup header and footer, restyled header and footer, restyle badges, hide cancelled cd alerts, changed icon to thunderstorm, auto change to warning econ when cd alert is present";
  //Planned 
  const plannedadds = "cors config, js files and package for other systems, geonet cap feed adition, unplanned out power outages with custom alert and config, div mode, expired alert window with config, unplanned outages from top energy,road closures from nzta,button location,";
  //alerts config
  const SHOW_EXPIRED_ALERTS = true; // Change to true to show expired alerts
  const SHOW_NON_FAR_NORTH_ALERTS = false; //show all alerts in the feed
  const REQUIRE_ONSET_WITHIN_WINDOW = true; //filter results based on how long to start time
  const HOUR_WINDOW = 24; //Amount of hours between the alert start time and date and the current time and date
  const proxy = "https://corsproxy.io/?"; //cors proxy url
  //Met service feed url with proxy add in, this should be a github url, we dont want to overload metservices infrastructure in an emergency
  const feedURL = proxy + encodeURIComponent("https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/alerts/archive/latest_2025-07-28T08-21-52-472Z.xml");
  //Civil defence live feed tester and visialsier - https://codepen.io/Amorangi-Mathews/full/QwjGPyv
  //Met service feed visualiser and tester https://codepen.io/Amorangi-Mathews/full/WbQGRvr
// Civil defence alerts 
  const ENABLE_CD_ALERTS = true; // Set to false to disable Civil Defence alerts
const CD_ALERT_FEED_URL = "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/alerts/CivilDefenceTest.xml"; //civil defence alert feed (atom)
  const SHOW_CANCELLED_CD_ALERTS = false; // Change to true to display CD alerts with msgType "Cancel"

 //custom geojson area alerts 
const SHOW_CUSTOM_GEOJSON_ALERTS = true; //Show alerts for custom areas that are defined
const USE_PROXY_FOR_CUSTOM_GEOJSON = true;  //use proxy for custom grojson urls under the custom geo areas

const DISABLE_FAR_NORTH_ALERTS = false;    //Hide Far north geo jason alerts 
//const withinTime = true; legacy content, was the alternative to isitactivestill
  let farNorthGeoJSON = null;
//Far north geojson config
  const GEOJSON_KEY = "farNorthGeoJSON";
  const GEOJSON_TIMESTAMP_KEY = "farNorthGeoJSON_timestamp";
  const GEOJSON_EXPIRY_HOURS = 24; //Time period for Far North geojson, script will check every this hours if the stored geojson is the same as the current one

  //check to see if the stored Far North geojson is still ative, uses geo expiry hours
  function isGeoJSONExpired() {
    const saved = localStorage.getItem(GEOJSON_TIMESTAMP_KEY);
    if (!saved) return true;
    const age = (Date.now() - parseInt(saved)) / (1000 * 60 * 60);
    return age > GEOJSON_EXPIRY_HOURS;
  }
//custom geo areas polygon creator https://codepen.io/Amorangi-Mathews/full/yyYgmLM 
  const CustomGeoAreas = {/*
  Area1: {
    type: "FeatureCollection",
    name: "Area 1",
    features: [
      {
        type: "Feature",
        properties: { Name: "Custom Area 1" },
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [173.295593, -35.250529],
              [173.298374, -35.251049],
              [173.299805, -35.248748],
              [173.295593, -35.250529]
            ]
          ]
        }
      }
    ]
  },*/
  /*  "Far North": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/farnorth.geojson", */
    "Ōturū marae": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/Marae/oturumarae.geojson",
         "Whangārei District": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/whangarei.geojson",
 /* "Gisborne": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/gisborne.geojson",
   "Nelson": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/nelson.geojson", 
     "Southland": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/cantosouth.geojson", */
};
  
  // or: const newGeoJSON = { type: "FeatureCollection", features: [...] };
const newGeoJSON = "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/farnorth.geojson";

  //try and load far north geo json
  async function loadFarNorthGeoJSON() {
  if (!isGeoJSONExpired()) {
    try {
      const stored = JSON.parse(localStorage.getItem(GEOJSON_KEY));
      if (stored && stored.type === "FeatureCollection") return stored;
    } catch {
      console.warn("Corrupted stored Far North GeoJSON, regenerating.");
    }
  }

  let finalGeoJSON = null;
//if there is a url load through a proxy if enabled
  try {
    if (typeof newGeoJSON === "string") {
      const url = USE_PROXY_FOR_CUSTOM_GEOJSON ? proxy + encodeURIComponent(newGeoJSON) : newGeoJSON;
      const res = await fetch(url);
      finalGeoJSON = await res.json();
    } else if (newGeoJSON?.type === "FeatureCollection") {
      finalGeoJSON = newGeoJSON;
    }
  } catch (e) {
    console.warn("Failed to load newGeoJSON:", e);
  } 

  if (finalGeoJSON) {
    localStorage.setItem(GEOJSON_KEY, JSON.stringify(finalGeoJSON));
    localStorage.setItem(GEOJSON_TIMESTAMP_KEY, Date.now().toString());
  }

  return finalGeoJSON;
}

//custom sorting for areas displayed in the alert html from the custom geo area

const AREA_DISPLAY_ORDER = [
"Far North District",
"Far North",
"Ōturū marae",
 "Whangārei District",
"Gisborne",
"Nelson",
"Southland",
];


//Format the times

  function formatReadableTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleString('en-NZ', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  } 
  //predifinitions and clering 
  let customGeoAreas = [];
let combinedAlertList = []; // Holds all alerts for sorting and display
  
  
  //check metservice feed, create html, sort
async function fetchAlerts() {
  try {
    const res = await fetch(feedURL);
    const xmlText = await res.text();
    const xml = new DOMParser().parseFromString(xmlText, "application/xml");
    const ns = "http://www.w3.org/2005/Atom";
    const entries = [...xml.getElementsByTagNameNS(ns, "entry")];
    const links = entries.map(e => e.querySelector("link[rel='related']")?.getAttribute("href")).filter(Boolean);

    const alertList = [];

    for (const url of links) {
      const capRes = await fetch(proxy + encodeURIComponent(url));
      const capText = await capRes.text();
      const capXML = new DOMParser().parseFromString(capText, "application/xml");
      const capNS = "urn:oasis:names:tc:emergency:cap:1.2";

      const info = capXML.getElementsByTagNameNS(capNS, "info")[0];
      if (!info) continue;

      function getParameterValue(infoNode, paramName) {
        const params = infoNode.getElementsByTagNameNS(capNS, "parameter");
        for (const param of params) {
          const name = param.getElementsByTagNameNS(capNS, "valueName")[0]?.textContent;
          const value = param.getElementsByTagNameNS(capNS, "value")[0]?.textContent;
          if (name && value && name === paramName) return value;
        }
        return "";
      }

      const get = tag => info.getElementsByTagNameNS(capNS, tag)[0]?.textContent || '';
      const headline = get("headline");
      const description = get("description");
      const onset = get("onset");
      const expires = get("expires");
      const event = get("event");
      const severity = get("severity");
      const certainty = get("certainty");
      const areaDesc = info.getElementsByTagNameNS(capNS, "areaDesc")[0]?.textContent || '';
      const web = get("web");

      const colourCode = getParameterValue(info, "ColourCode");
      const colourClass = colourCode ? `alert-${colourCode.toLowerCase()}` : 'alert-default';

      const polygons = [...info.getElementsByTagNameNS(capNS, "polygon")];
      const geoCoords = [];

      polygons.forEach(p => {
        const coords = p.textContent.trim().split(" ").map(pair => {
          const [lat, lon] = pair.split(",").map(Number);
          return [lon, lat];
        });
        geoCoords.push(coords);
      });

let intersects = false;
let matchedAreaNames = [];

geoCoords.forEach(coords => {
  const poly = turf.polygon([coords]);

  // Far North
  if (!DISABLE_FAR_NORTH_ALERTS && farNorthGeoJSON && turf.booleanIntersects(poly, farNorthGeoJSON)) {
    intersects = true;
    if (!matchedAreaNames.includes("Far North District")) {
      matchedAreaNames.push("Far North District");
    }
  }

  // Custom Areas
  if (SHOW_CUSTOM_GEOJSON_ALERTS && customGeoAreas.length) {
    const keys = Object.keys(CustomGeoAreas);
    for (let i = 0; i < customGeoAreas.length; i++) {
      const custom = customGeoAreas[i];
      const name = keys[i] || "a custom area";
      if (turf.booleanIntersects(poly, custom)) {
        intersects = true;
        if (!matchedAreaNames.includes(name)) {
          matchedAreaNames.push(name);
        }
      }
    }
  }
});




      const now = new Date();
      let alertStatus = "";
      if (onset && expires) {
        const onsetTime = new Date(onset);
        const expiresTime = new Date(expires);
        if (now >= onsetTime && now <= expiresTime) {
          alertStatus = "active-now";
        } else if (now < onsetTime) {
          alertStatus = "upcoming";
        } else {
          alertStatus = "expired";
        }
      } else {
        alertStatus = "active-now"; // fallback
      }

      const isAllowedStatus =
        alertStatus === "active-now" ||
        alertStatus === "upcoming" ||
        (alertStatus === "expired" && SHOW_EXPIRED_ALERTS);

      const qualifies = intersects && isAllowedStatus;

      matchedAreaNames.sort((a, b) => {
  const iA = AREA_DISPLAY_ORDER.indexOf(a);
  const iB = AREA_DISPLAY_ORDER.indexOf(b);
  return (iA === -1 ? 999 : iA) - (iB === -1 ? 999 : iB); // fallback to end if not found
});

//banner conect for the met service cap feed related alerts      
      const alertHTML = `
<div class="alert-card ${qualifies ? 'far-north' : ''} ${alertStatus} ${colourClass}">
  <b>${headline} issued for ${areaDesc}</b><br>
  MetService has issued a weather alert that includes parts of ${formatAreaList(matchedAreaNames)}
  ${onset ? ` from ${formatReadableTime(onset)} ` : ''}
  ${expires ? `to ${formatReadableTime(expires)}</i>.<br>` : ''}   
  ${web ? `<a href="${web}" target="_blank">Visit MetService website for more information.</a><br>` : ''}
  <span class="badge alert-met">MetService</span>
  ${colourCode ? `<span class="badge ${colourClass}">${colourCode}</span>` : ''}
  ${alertStatus === 'upcoming' ? `<span class="badge upcoming-badge">Upcoming</span> ` : ''} 
  ${alertStatus === 'active-now' ? `<span class="badge active-badge">Active Now</span><br>` : ''}
  ${alertStatus === 'expired' ? `<span class="badge expired-badge">Expired</span>` : ''}
</div>`;

     if (qualifies) {
combinedAlertList.push({ html: alertHTML, status: alertStatus, source: 'met', areas: matchedAreaNames }); // in fetchAlerts 

} else if (  
  SHOW_NON_FAR_NORTH_ALERTS &&
  (alertStatus === "active-now" || alertStatus === "upcoming" || (alertStatus === "expired" && SHOW_EXPIRED_ALERTS))
) {
combinedAlertList.push({ html: alertHTML, status: alertStatus, source: 'met', areas: matchedAreaNames }); // in fetchAlerts

}
    }

    // STEP 2: Sort alerts: active-now > upcoming > expired
    const statusOrder = { "active-now": 1, "upcoming": 2, "expired": 3 };
    alertList.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));

    const floatingEl = document.getElementById("floating-alerts-container");
    const toggleBtn = document.getElementById("toggle-alerts-btn");

    if (alertList.length) {
      floatingEl.innerHTML = alertList.map(a => a.html).join("\n");
      toggleBtn.style.display = "flex";
    } else {
      floatingEl.innerHTML = "";
      toggleBtn.style.display = "none";
    }
    lastUpdatedTime = new Date().toISOString();
renderCombinedAlerts();
  } catch (err) {
    console.error(err);
  }
}

  
  //check civil denfence atom cap feed, check areas, make alerts html, sort
async function fetchCDAlerts() {
  if (!ENABLE_CD_ALERTS) return;

  try {
    const res = await fetch(proxy + encodeURIComponent(CD_ALERT_FEED_URL));
    const xmlText = await res.text();
    const xml = new DOMParser().parseFromString(xmlText, "application/xml");
    const ns = "http://www.w3.org/2005/Atom";
    const entries = [...xml.getElementsByTagNameNS(ns, "entry")];

    const cdAlertList = [];

    for (const entry of entries) {
      const contentXML = entry.getElementsByTagNameNS(ns, "content")[0]?.textContent;
      if (!contentXML) continue;

      const capXML = new DOMParser().parseFromString(contentXML, "application/xml");
      const capNS = "urn:oasis:names:tc:emergency:cap:1.2";

      const getTag = (parent, tag) => parent.getElementsByTagNameNS(capNS, tag)[0]?.textContent || '';
      const info = capXML.getElementsByTagNameNS(capNS, "info")[0];
      if (!info) continue;

      const areaNodes = [...info.getElementsByTagNameNS(capNS, "area")];

      // Extract base CAP fields
      const identifier = getTag(capXML, "identifier");
      const sent = getTag(capXML, "sent");
      const status = getTag(capXML, "status");
      const msgType = getTag(capXML, "msgType");
      const scope = getTag(capXML, "scope");
      const senderName = getTag(info, "senderName");
      const headline = getTag(info, "headline");
      const effective = getTag(info, "effective");
      const expires = getTag(info, "expires");
      const urgency = getTag(info, "urgency");
      const severity = getTag(info, "severity");
      const certainty = getTag(info, "certainty");

      // Check time windows
      const now = new Date();
      const onsetTime = new Date(effective);
      const expiresTime = new Date(expires);
      let alertStatus = "";

      if (now >= onsetTime && now <= expiresTime) {
        alertStatus = "active-now";
      } else if (now < onsetTime) {
        alertStatus = "upcoming";
      } else {
        alertStatus = "expired";
      }

      const isAllowedStatus =
        alertStatus === "active-now" ||
        alertStatus === "upcoming" ||
        (alertStatus === "expired" && SHOW_EXPIRED_ALERTS);

    let intersects = false;
let areaDesc = "";
let matchedAreaNames = [];
const geoCoords = [];

areaNodes.forEach(area => {
  const desc = area.getElementsByTagNameNS(capNS, "areaDesc")[0]?.textContent || '';
  const polyEls = [...area.getElementsByTagNameNS(capNS, "polygon")];

  areaDesc += desc + "; ";

  polyEls.forEach(p => {
    const coords = p.textContent.trim().split(" ").map(pair => {
      const [lat, lon] = pair.split(",").map(Number);
      return [lon, lat];
    });
    geoCoords.push(coords);
  });
});

geoCoords.forEach(coords => {
  const poly = turf.polygon([coords]);

  // Far North
  if (!DISABLE_FAR_NORTH_ALERTS && farNorthGeoJSON && turf.booleanIntersects(poly, farNorthGeoJSON)) {
    intersects = true;
    if (!matchedAreaNames.includes("Far North District")) {
      matchedAreaNames.push("Far North District");
    }
  }

  // Custom Areas
  if (SHOW_CUSTOM_GEOJSON_ALERTS && customGeoAreas.length) {
    const keys = Object.keys(CustomGeoAreas);
    for (let i = 0; i < customGeoAreas.length; i++) {
      const custom = customGeoAreas[i];
      const name = keys[i] || "a custom area";
      if (turf.booleanIntersects(poly, custom)) {
        intersects = true;
        if (!matchedAreaNames.includes(name)) {
          matchedAreaNames.push(name);
        }
      }
    }
  }
});

      const isCancelled = msgType.toLowerCase() === "cancel";
const qualifies =
  intersects &&
  isAllowedStatus &&
  (!isCancelled || (isCancelled && SHOW_CANCELLED_CD_ALERTS));


      const formatNZTime = iso => {
        if (!iso) return '';
        const dt = new Date(iso);
        return dt.toLocaleString("en-NZ", {
          weekday: "long",
          day: "numeric",
          month: "long",
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
          timeZone: "Pacific/Auckland"
        });
      };
      
      matchedAreaNames.sort((a, b) => {
  const iA = AREA_DISPLAY_ORDER.indexOf(a);
  const iB = AREA_DISPLAY_ORDER.indexOf(b);
  return (iA === -1 ? 999 : iA) - (iB === -1 ? 999 : iB); // fallback to end if not found
});


      const alertHTML = `
<div class="alert-card far-north alert-red ${alertStatus}">
  <b>${headline}</b><br>
  ${senderName} has issued an alert that covers parts of   ${formatAreaList(matchedAreaNames)} from ${formatNZTime(effective)}
  to ${formatNZTime(expires)}.<br>
  <b>Urgency:</b> ${urgency} <b>Severity:</b> ${severity}<br>
  <span class="badge alert-cd">Civil Defence</span>
  ${alertStatus === 'upcoming' ? `<span class="badge upcoming-badge">Upcoming</span>` : ''}
  ${alertStatus === 'active-now' ? `<span class="badge active-badge">Active Now</span>` : ''}
  ${alertStatus === 'expired' ? `<span class="badge expired-badge">Expired</span>` : ''}
${isCancelled ? `<span class="badge cancelled-badge">Cancelled</span><br>` : ''}
  <br><a href="https://www.civildefence.govt.nz/" target="_blank">Visit civildefence.govt.nz for more information</a>
</div>`;

      if (qualifies) {
combinedAlertList.push({ html: alertHTML, status: alertStatus, source: 'cd', areas: matchedAreaNames }); // in fetchCDAlerts

      } else if (
        SHOW_NON_FAR_NORTH_ALERTS &&
        (alertStatus === "active-now" || alertStatus === "upcoming" || (alertStatus === "expired" && SHOW_EXPIRED_ALERTS))
      ) {
combinedAlertList.push({ html: alertHTML, status: alertStatus, source: 'cd', areas: matchedAreaNames }); // in fetchCDAlerts

      }
    }

    // Sort and render CD alerts
    const statusOrder = { "active-now": 1, "upcoming": 2, "expired": 3 };
    cdAlertList.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));

    const floatingEl = document.getElementById("floating-alerts-container");
    const toggleBtn = document.getElementById("toggle-alerts-btn");

    if (cdAlertList.length) {
      floatingEl.innerHTML += cdAlertList.map(a => a.html).join("\n");
      toggleBtn.style.display = "flex";
    }
    lastUpdatedTime = new Date().toISOString();
renderCombinedAlerts();
  } catch (err) {
    console.error("CD Alert fetch failed", err);
  }
}

Promise.all([loadFarNorthGeoJSON(), loadCustomGeoJSONAreas()])
  .then(([farNorth, customAreas]) => {
    farNorthGeoJSON = farNorth;
    customGeoAreas = customAreas;
    return Promise.all([fetchCDAlerts(), fetchAlerts()]);
  })
  .then(renderCombinedAlerts);

 async function loadCustomGeoJSONAreas() {
  const areas = [];

  for (const key in CustomGeoAreas) {
    const entry = CustomGeoAreas[key];

    if (typeof entry === "string") {
      try {
        const url = USE_PROXY_FOR_CUSTOM_GEOJSON ? proxy + encodeURIComponent(entry) : entry;
        const res = await fetch(url);
        const geojson = await res.json();
        if (geojson.type === "FeatureCollection") {
          areas.push(geojson);
        }
      } catch (e) {
        console.warn(`Failed to fetch custom GeoJSON for ${key}:`, e);
      }
    } else if (entry?.type === "FeatureCollection") {
      areas.push(entry);
    }
  }

  return areas;
} 
  // Order: CD alerts first, then MetService — within each group, sort by status   
function renderCombinedAlerts() {
  const statusOrder = { "active-now": 1, "upcoming": 2, "expired": 3 };

  combinedAlertList.sort((a, b) => {
    if (a.source !== b.source) return a.source === 'cd' ? -1 : 1;
    return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99);
  });

  const floatingEl = document.getElementById("floating-alerts-container");
  const toggleBtn = document.getElementById("toggle-alerts-btn");

  if (combinedAlertList.length) {
    const allAreaMentions = combinedAlertList
      .flatMap(a => a.areas || [])
      .filter((v, i, a) => a.indexOf(v) === i);
    const areaLabel = formatAreaList(allAreaMentions);
const hasCDAlert = combinedAlertList.some(a => a.source === 'cd');
toggleBtn.textContent = hasCDAlert ? "⚠️" : "🌧️";
    const introHTML = `
      <div class="alert-header">
        <strong>Local warnings and alerts</strong><br>
        Currently showing local warnings and alerts for ${areaLabel}.
       </div>`;

    const footerHTML = `
      <hr>
      <div class="alert-footer">
        <small>
          Last updated: ${formatReadableTime(lastUpdatedTime)}<br>
          <a href="https://almokinsgov.github.io/Region-warning-and-alerts/" target="_blank">Region Warnings and Alert System</a>, Current version ${version}
        </small>
      </div>`;

    floatingEl.innerHTML = introHTML + combinedAlertList.map(a => a.html).join("\n") + footerHTML;
    toggleBtn.style.display = "flex";
  } else {
    floatingEl.innerHTML = "";
    toggleBtn.style.display = "none";
  }
}



  function isStillActive(onsetText, expiresText) {
  const now = new Date();
  const onset = onsetText ? new Date(onsetText) : null;
  const expires = expiresText ? new Date(expiresText) : null;

  if (expires && now > expires) return false;
  if (onset && now < onset) return true;
  if (onset && expires) return now >= onset && now <= expires;
  if (expires) return now <= expires;

  return true;
}

  
 function isWithinHourWindow(onsetText, expiresText) {
  const now = new Date();
  const onset = onsetText ? new Date(onsetText) : null;
  const expires = expiresText ? new Date(expiresText) : null;
 
  if (onset && expires) {
    const isActive = now >= onset && now <= expires;
    const startsSoon = onset > now && (onset - now) / 1000 / 3600 <= HOUR_WINDOW;
    return isActive || startsSoon;
  }

  if (onset) {
    const diffHours = (onset - now) / 1000 / 3600;
    const inWindow = diffHours >= 0 && diffHours <= HOUR_WINDOW;
    return inWindow;
  }

  return false;
}

function formatAreaList(areaArray) {
  if (!areaArray || areaArray.length === 0) return "the alert region";
  if (areaArray.length === 1) return areaArray[0];
  if (areaArray.length === 2) return `${areaArray[0]} and ${areaArray[1]}`;
  return `${areaArray.slice(0, -1).join(", ")}, and ${areaArray[areaArray.length - 1]}`;
}

  document.getElementById("toggle-alerts-btn").addEventListener("click", () => {
    const el = document.getElementById("floating-alerts-container");
    el.style.display = (el.style.display === "none" || !el.style.display) ? "block" : "none";
  });
</script>
  
  
</head>

<body>
  <header>
    <svg class="hero-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M13 2L3 14H12L11 22L21 10H13L13 2Z" fill="white"/>
    </svg>
    <h1>Region Warnings and Alerts (Beta)</h1>
    <p>Real-time, locally filtered warnings from official sources, built to integrate and run on any modern <span class="inline-translate" data-tooltip="website">pae tukutuku<span class="māori-translation"> (website)</span></span>.</p>
  </header>

  <main>
    <div style="text-align: right; max-width: 900px; margin: 1rem auto;">
      <label>
        <input type="checkbox" id="toggle-translations" />
        <strong>Show English translations</strong>
      </label>
    </div>

    <section>
      <h2>What this tool offers</h2>
      <p>
        This system turns national emergency feeds into clear, location-specific warnings. Built for councils and 
        <span class="inline-translate" data-tooltip="communities">hapori <span class="māori-translation">(communities)</span></span>, 
        it’s fast, embeddable, and geospatially aware. Filtering alerts using real GIS areas, not guesswork.
      </p>

      <div class="feature-list">
        <div class="feature">
          <h3>
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path fill="currentColor" d="M1 21h22L12 2 1 21zm13-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
            </svg>
            Real-time alerts
          </h3>
          <p>
            Surfaces critical MetService and Civil Defence warnings as soon as they apply to your 
            <span class="inline-translate" data-tooltip="region">rohe <span class="māori-translation">(region)</span></span>.
          </p>
        </div>

        <div class="feature">
          <h3>
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
            </svg>
            Geospatial accuracy
          </h3>
          <p>
            Uses true polygon detection, alerts only show if they intersect defined local 
            <span class="inline-translate" data-tooltip="boundaries">rohe <span class="māori-translation">(boundaries)</span></span>.
          </p>
        </div>

        <div class="feature">
          <h3>
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path fill="currentColor" d="M7 3v6h10V3h2v6h2v2h-2v4c0 2.21-1.79 4-4 4h-1v4h-2v-4h-1c-2.21 0-4-1.79-4-4v-4H3v-2h2V3h2z"/>
            </svg>
            Easy integration
          </h3>
          <p>
            Drop into any homepage, dashboard, or partner site with minimal setup or 
            <span class="inline-translate" data-tooltip="requirements">whakaritenga <span class="māori-translation">(requirements)</span></span>.
          </p>
        </div>
      </div>
    </section>

    <section>
      <h2>Live demos coming soon</h2>
      <p>
        We’re preparing demo environments for specific councils and 
        <span class="inline-translate" data-tooltip="regions">rohe <span class="māori-translation">(regions)</span></span> using past alert data. 
        Want a demo set up for your area?
      </p>
      <a href="https://forms.gle/wP68BVjsRVyvMVZi9" class="button">Register your interest</a>
    </section>

    <section style="max-width: 900px; margin: 3rem auto; padding: 2rem; background: #ffffff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-family: 'Inter', sans-serif;">
      <h2 style="color: #dc3545; font-size: 2rem; margin-bottom: 1rem; text-align: center;">Key features</h2>
      <ul style="list-style: none; padding: 0; margin: 0; line-height: 1.6;">
        <li><strong>🛰 Real-time alert detection:</strong> Pulls live CAP alerts from MetService and Civil Defence</li>
        <li><strong>🗺 Geospatial filtering:</strong> Checks intersection with defined or custom GeoJSON boundaries</li>
        <li><strong>🧭 Custom map zones:</strong> Supports local overlays (e.g. 
          <span class="inline-translate" data-tooltip="meeting house">marae <span class="māori-translation">(meeting house)</span></span>, suburbs, 
          <span class="inline-translate" data-tooltip="tribal area">iwi <span class="māori-translation">(tribal area)</span></span> areas)
        </li>
        <li><strong>🧰 Modular config:</strong> Enable/disable feeds, filters, and display logic using easy flags</li>
        <li><strong>🧾 Clear, human-readable display:</strong> Converts raw XML data into scannable summaries with context</li>
        <li><strong>🔁 Serverless & lightweight:</strong> Deploy with plain HTML + JS, no backend needed</li>
        <li><strong>🧪 Archived feed support:</strong> Plug in old alerts for training, demos, or scenario testing</li>
        <li><strong>🖼 Embeddable UI:</strong> Responsive floating panel or inline component that adapts to your layout</li>
        <li><strong>🌐 Multi-organisation ready:</strong> Adaptable for use by other councils, agencies, or partner websites</li>
      </ul>
    </section>

    <section>
      <h2>See it in action</h2>
      <p>Tap the ⚠️ icon in the lower right corner to activate the alerts panel.</p>
    </section>

    <section>
      <h2>GitHub</h2>
      <p>Source code, releases, and documentation are available in the official repository.</p>
      <a href="https://github.com/almokinsgov/Region-warning-and-alerts" class="button">Visit the GitHub Repo</a>
    </section>
  </main>

  <footer>
    &copy; 2025 Region Alert Platform · Amorangi Mathews · For Civil Defence and 
    <span class="inline-translate" data-tooltip="community">whānau <span class="māori-translation">(community)</span></span>
  </footer>

  <style>
    .inline-translate {
      position: relative;
      border-bottom: 1px dotted #666;
      cursor: help;
    }

    .inline-translate::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 0;
      background: #333;
      color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
      white-space: nowrap;
      font-size: 12px;
      opacity: 0;
      pointer-events: none;
      transform: translateY(5px);
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 10;
    }

    .inline-translate:hover::after {
      opacity: 1;
      transform: translateY(0);
    }

    .māori-translation {
      display: none;
      font-weight: normal;
      font-style: normal;
      color: #555;
    }
  </style>

  <script>
    document.getElementById('toggle-translations').addEventListener('change', function () {
      const translations = document.querySelectorAll('.māori-translation');
      translations.forEach(el => {
        el.style.display = this.checked ? 'inline' : 'none';
      });
    });
  </script>
</body>

</html>
