<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Region warning and alerts</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #dc3545;
      --secondary: #3a3d42;
      --background: #f4f6f8;
      --light: #ffffff;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--background);
      color: var(--secondary);
      line-height: 1.6;
    }

    header {
      background: linear-gradient(to right, #dc3545, #ff6b6b);
      color: var(--light);
      text-align: center;
      padding: 4rem 1rem 2rem;
    }

    header h1 {
      margin: 0;
      font-size: 2.5rem;
    }

    header p {
      margin-top: 0.5rem;
      font-size: 1.2rem;
      opacity: 0.9;
    }

    .hero-icon {
      width: 80px;
      height: 80px;
      margin: 1rem auto;
      fill: white;
      opacity: 0.9;
    }

    main {
      padding: 2rem 1rem;
      max-width: 960px;
      margin: auto;
    }

    section {
      background: var(--light);
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 2rem;
      margin-bottom: 2rem;
    }

    section h2 {
      margin-top: 0;
      font-size: 1.5rem;
      color: var(--secondary);
    }

    footer {
      text-align: center;
      font-size: 0.9rem;
      color: #777;
      padding: 2rem 1rem;
    }

    a.button {
      display: inline-block;
      background-color: var(--primary);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      text-decoration: none;
      margin-top: 1rem;
      font-weight: 600;
      transition: background 0.3s ease;
    }

    a.button:hover {
      background-color: #b02a37;
    }

    .feature-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 1.5rem;
      margin-top: 1.5rem;
    }

    .feature {
      background: #fefefe;
      border-radius: 10px;
      padding: 1rem;
      border-left: 5px solid var(--primary);
    }

    .feature h3 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }

    .feature svg {
      width: 24px;
      height: 24px;
      vertical-align: middle;
      margin-right: 0.4rem;
      fill: var(--primary);
    }
  </style>

    <style>
    .alert-card {
      background: #fff0f0;
      border-left: 5px solid #ffa500;
      margin-bottom: 1rem;
      padding: 1rem;
      border-radius: 6px;
    }
    .far-north {
      border-left-color: #dc3545;
      /* background: #fff0f0; */
    }

    /* Floating alerts window and toggle icon */
    #floating-alerts-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 450px;
      max-height: 70vh;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      border-left: 4px solid #FFFFFF;
      border-radius: 8px;
      padding: 1rem;
          font-size: 13.8px;
    line-height: normal;
    }

    #toggle-alerts-btn {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      width: 48px;
      height: 48px;
      background: #ffcc00;
      border-radius: 50%;
      border: none;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
      font-size: 24px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 1001;
    }

    #toggle-alerts-btn:hover {
      background: #ffaa00;
    }
    
    @media (max-width: 600px) {
  #floating-alerts-container {
    width: 90vw;
    right: 0.5rem;
    left: 0.5rem;
    bottom: 4rem;
    max-height: 60vh;
    border-left-width: 3px;
    font-size: 0.95em;
        font-size: 13.8px;
    line-height: normal;
  }}

.badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.8em;
  margin-top: 4px;
}

.active-now {
 /*  border-left-color: #e53935 !important;
  background: #ffeaea;  */
}

.upcoming {
/*  border-left-color: #0288d1 !important;
  background: #e3f2fd; */
}

.active-badge {
  background: #e53935;
  color: white;
}

.upcoming-badge {
  background: #e53935;
  color: white;
}
/* Default fallback */
.alert-default {
  border-left-color: #ffa500;
  background: #fffaf0;
}

.alert-orange {
  border-left-color: #FF8918;
  background: #fff3e0;
}
 
.alert-red {
  border-left-color: #d32f2f;
  background: #fdecea;
}

.alert-cd {
  border-left-color: #d32f2f;
  background: #123c59;
      border: solid;
    border-width: thin;
    border-color: #fffc38;
}

.alert-yellow {
  border-left-color: #fbc02d;
  background: #fffde7;
}

.alert-green {
  border-left-color: #388e3c;
  background: #e8f5e9;
}

/* Badge styles */
.badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.8em;
  margin-top: 4px;
  font-weight: 600;
  color: white;
}

.badge.alert-orange { background: #FF8918; }
.badge.alert-red { background: #d32f2f; }
.badge.alert-yellow { background: #fbc02d; color: black; }
.badge.alert-cd {color: white; }
.badge.alert-green { background: #388e3c; }

.active-now {
  /* optional override styles */
}

.upcoming {
  /* optional override styles */
}

    .expired-badge {
  background: #9e9e9e;
  color: white;
}
  </style>

  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
</head>
<body> 
 
<!-- Floating Alerts UI -->
<div id="floating-alerts-container"></div>
<button id="toggle-alerts-btn" title="Weather Alerts">üåßÔ∏èÔ∏è</button>

  <script>


</script>
  
<script>
  const version = "1.3.1.6";
  const functions = "Alert display, Container, Popup, onset window, non far north display, isstillactivecolour classes, simpilfy, cachefix, expiry tag, sorted, expiry hide, CD alerts added, sorting, badges, formatted alrert for cd, custom geo area with proxy and url support,  newgeojsonurl, temp urls for cd and met, area name extraction and apply to alert html,disable far north alerts, custom new geo json url. area definitions , html edit (msgType removed), multi area in alert html with and for multi location, custom sorted custom area";
   const plannedadds = "cors config, js files and package for other systems, geonet cap feed adition, unplanned out power outages with custom alert and config, div mode, expired alert window with config";
  const SHOW_EXPIRED_ALERTS = true; // Change to true to show expired alerts
  const SHOW_NON_FAR_NORTH_ALERTS = false;
  const REQUIRE_ONSET_WITHIN_WINDOW = true;
  const HOUR_WINDOW = 24;
  const proxy = "https://corsproxy.io/?";
  const feedURL = proxy + encodeURIComponent("https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/alerts/archive/latest_2025-07-28T08-21-52-472Z.xml");
  //Civil defence live feed tester and visialsier - https://codepen.io/Amorangi-Mathews/full/QwjGPyv
  //Met service feed visualiser and tester https://codepen.io/Amorangi-Mathews/full/WbQGRvr
// Civil defence alerts 
  const ENABLE_CD_ALERTS = true; // Set to false to disable Civil Defence alerts
const CD_ALERT_FEED_URL = "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/alerts/CivilDefenceTest.xml";
 //custom geojson area alerts 
const SHOW_CUSTOM_GEOJSON_ALERTS = true;
const USE_PROXY_FOR_CUSTOM_GEOJSON = true; 
  //Hide Far north geo jason alerts 
const DISABLE_FAR_NORTH_ALERTS = false;  
//const withinTime = true;
  let farNorthGeoJSON = null;
//Far north geojson config
  const GEOJSON_KEY = "farNorthGeoJSON";
  const GEOJSON_TIMESTAMP_KEY = "farNorthGeoJSON_timestamp";
  const GEOJSON_EXPIRY_HOURS = 24;

  function isGeoJSONExpired() {
    const saved = localStorage.getItem(GEOJSON_TIMESTAMP_KEY);
    if (!saved) return true;
    const age = (Date.now() - parseInt(saved)) / (1000 * 60 * 60);
    return age > GEOJSON_EXPIRY_HOURS;
  }
//custom geo areas polygon creator https://codepen.io/Amorangi-Mathews/full/yyYgmLM 
  const CustomGeoAreas = {/*
  Area1: {
    type: "FeatureCollection",
    name: "Area 1",
    features: [
      {
        type: "Feature",
        properties: { Name: "Custom Area 1" },
        geometry: {
          type: "Polygon",
          coordinates: [
            [
              [173.295593, -35.250529],
              [173.298374, -35.251049],
              [173.299805, -35.248748],
              [173.295593, -35.250529]
            ]
          ]
        }
      }
    ]
  },*/
   /* "Far North": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/farnorth.geojson", */
    "Oturu marae": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/Marae/oturumarae.geojson",
         "Whangarei": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/whangarei.geojson",
  /*"Gisborne": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/gisborne.geojson",
   "Nelson": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/nelson.geojson",
     "Southland": "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/cantosouth.geojson", */
};
  
  // or: const newGeoJSON = { type: "FeatureCollection", features: [...] };
const newGeoJSON = "https://raw.githubusercontent.com/almokinsgov/NZSHAPE/refs/heads/main/Areas/farnorth.geojson";

  //try and load far north geo json
  async function loadFarNorthGeoJSON() {
  if (!isGeoJSONExpired()) {
    try {
      const stored = JSON.parse(localStorage.getItem(GEOJSON_KEY));
      if (stored && stored.type === "FeatureCollection") return stored;
    } catch {
      console.warn("Corrupted stored Far North GeoJSON, regenerating.");
    }
  }

  let finalGeoJSON = null;
//if there is a url load through a proxy if enabled
  try {
    if (typeof newGeoJSON === "string") {
      const url = USE_PROXY_FOR_CUSTOM_GEOJSON ? proxy + encodeURIComponent(newGeoJSON) : newGeoJSON;
      const res = await fetch(url);
      finalGeoJSON = await res.json();
    } else if (newGeoJSON?.type === "FeatureCollection") {
      finalGeoJSON = newGeoJSON;
    }
  } catch (e) {
    console.warn("Failed to load newGeoJSON:", e);
  }

  if (finalGeoJSON) {
    localStorage.setItem(GEOJSON_KEY, JSON.stringify(finalGeoJSON));
    localStorage.setItem(GEOJSON_TIMESTAMP_KEY, Date.now().toString());
  }

  return finalGeoJSON;
}

//custom sorting for areas displayed in the alert html from the custom geo area

const AREA_DISPLAY_ORDER = [
"Far North District",
"Far North",
"Oturu marae",
 "Whangarei",
"Gisborne",
"Nelson",
"Southland",
];


//Format the times

  function formatReadableTime(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleString('en-NZ', {
      weekday: 'long',
      day: 'numeric',
      month: 'long',
      hour: 'numeric',
      minute: '2-digit',
      hour12: true
    });
  } 
  //predifinitions and clering 
  let customGeoAreas = [];
let combinedAlertList = []; // Holds all alerts for sorting and display
  
  //check metservice feed, create html, sort
async function fetchAlerts() {
  try {
    const res = await fetch(feedURL);
    const xmlText = await res.text();
    const xml = new DOMParser().parseFromString(xmlText, "application/xml");
    const ns = "http://www.w3.org/2005/Atom";
    const entries = [...xml.getElementsByTagNameNS(ns, "entry")];
    const links = entries.map(e => e.querySelector("link[rel='related']")?.getAttribute("href")).filter(Boolean);

    const alertList = [];

    for (const url of links) {
      const capRes = await fetch(proxy + encodeURIComponent(url));
      const capText = await capRes.text();
      const capXML = new DOMParser().parseFromString(capText, "application/xml");
      const capNS = "urn:oasis:names:tc:emergency:cap:1.2";

      const info = capXML.getElementsByTagNameNS(capNS, "info")[0];
      if (!info) continue;

      function getParameterValue(infoNode, paramName) {
        const params = infoNode.getElementsByTagNameNS(capNS, "parameter");
        for (const param of params) {
          const name = param.getElementsByTagNameNS(capNS, "valueName")[0]?.textContent;
          const value = param.getElementsByTagNameNS(capNS, "value")[0]?.textContent;
          if (name && value && name === paramName) return value;
        }
        return "";
      }

      const get = tag => info.getElementsByTagNameNS(capNS, tag)[0]?.textContent || '';
      const headline = get("headline");
      const description = get("description");
      const onset = get("onset");
      const expires = get("expires");
      const event = get("event");
      const severity = get("severity");
      const certainty = get("certainty");
      const areaDesc = info.getElementsByTagNameNS(capNS, "areaDesc")[0]?.textContent || '';
      const web = get("web");

      const colourCode = getParameterValue(info, "ColourCode");
      const colourClass = colourCode ? `alert-${colourCode.toLowerCase()}` : 'alert-default';

      const polygons = [...info.getElementsByTagNameNS(capNS, "polygon")];
      const geoCoords = [];

      polygons.forEach(p => {
        const coords = p.textContent.trim().split(" ").map(pair => {
          const [lat, lon] = pair.split(",").map(Number);
          return [lon, lat];
        });
        geoCoords.push(coords);
      });

let intersects = false;
let matchedAreaNames = [];

geoCoords.forEach(coords => {
  const poly = turf.polygon([coords]);

  // Far North
  if (!DISABLE_FAR_NORTH_ALERTS && farNorthGeoJSON && turf.booleanIntersects(poly, farNorthGeoJSON)) {
    intersects = true;
    if (!matchedAreaNames.includes("Far North District")) {
      matchedAreaNames.push("Far North District");
    }
  }

  // Custom Areas
  if (SHOW_CUSTOM_GEOJSON_ALERTS && customGeoAreas.length) {
    const keys = Object.keys(CustomGeoAreas);
    for (let i = 0; i < customGeoAreas.length; i++) {
      const custom = customGeoAreas[i];
      const name = keys[i] || "a custom area";
      if (turf.booleanIntersects(poly, custom)) {
        intersects = true;
        if (!matchedAreaNames.includes(name)) {
          matchedAreaNames.push(name);
        }
      }
    }
  }
});




      const now = new Date();
      let alertStatus = "";
      if (onset && expires) {
        const onsetTime = new Date(onset);
        const expiresTime = new Date(expires);
        if (now >= onsetTime && now <= expiresTime) {
          alertStatus = "active-now";
        } else if (now < onsetTime) {
          alertStatus = "upcoming";
        } else {
          alertStatus = "expired";
        }
      } else {
        alertStatus = "active-now"; // fallback
      }

      const isAllowedStatus =
        alertStatus === "active-now" ||
        alertStatus === "upcoming" ||
        (alertStatus === "expired" && SHOW_EXPIRED_ALERTS);

      const qualifies = intersects && isAllowedStatus;

      matchedAreaNames.sort((a, b) => {
  const iA = AREA_DISPLAY_ORDER.indexOf(a);
  const iB = AREA_DISPLAY_ORDER.indexOf(b);
  return (iA === -1 ? 999 : iA) - (iB === -1 ? 999 : iB); // fallback to end if not found
});

      
      const alertHTML = `
<div class="alert-card ${qualifies ? 'far-north' : ''} ${alertStatus} ${colourClass}">
  <b>${headline} issued for ${areaDesc}</b><br>
  MetService has issued a weather alert that includes parts of ${formatAreaList(matchedAreaNames)}
  ${onset ? ` from ${formatReadableTime(onset)} ` : ''}
  ${expires ? `to ${formatReadableTime(expires)}</i>.<br>` : ''}
  ${web ? `<a href="${web}" target="_blank">Visit MetService website for more information.</a><br>` : ''}
  ${colourCode ? `<span class="badge ${colourClass}">${colourCode}</span>` : ''}
  ${alertStatus === 'upcoming' ? `<span class="badge upcoming-badge">Upcoming</span> ` : ''}
  ${alertStatus === 'active-now' ? `<span class="badge active-badge">Active Now</span><br>` : ''}
  ${alertStatus === 'expired' ? `<span class="badge expired-badge">Expired</span>` : ''}
</div>`;

     if (qualifies) {
combinedAlertList.push({ html: alertHTML, status: alertStatus, source: 'met' }); // in fetchAlerts

} else if (
  SHOW_NON_FAR_NORTH_ALERTS &&
  (alertStatus === "active-now" || alertStatus === "upcoming" || (alertStatus === "expired" && SHOW_EXPIRED_ALERTS))
) {
combinedAlertList.push({ html: alertHTML, status: alertStatus, source: 'met' }); // in fetchAlerts

}
    }

    // üü° STEP 2: Sort alerts: active-now > upcoming > expired
    const statusOrder = { "active-now": 1, "upcoming": 2, "expired": 3 };
    alertList.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));

    const floatingEl = document.getElementById("floating-alerts-container");
    const toggleBtn = document.getElementById("toggle-alerts-btn");

    if (alertList.length) {
      floatingEl.innerHTML = alertList.map(a => a.html).join("\n");
      toggleBtn.style.display = "flex";
    } else {
      floatingEl.innerHTML = "";
      toggleBtn.style.display = "none";
    }
renderCombinedAlerts();
  } catch (err) {
    console.error(err);
  }
}

  
  //check civil denfence atom cap feed, check areas, make alerts html, sort
async function fetchCDAlerts() {
  if (!ENABLE_CD_ALERTS) return;

  try {
    const res = await fetch(proxy + encodeURIComponent(CD_ALERT_FEED_URL));
    const xmlText = await res.text();
    const xml = new DOMParser().parseFromString(xmlText, "application/xml");
    const ns = "http://www.w3.org/2005/Atom";
    const entries = [...xml.getElementsByTagNameNS(ns, "entry")];

    const cdAlertList = [];

    for (const entry of entries) {
      const contentXML = entry.getElementsByTagNameNS(ns, "content")[0]?.textContent;
      if (!contentXML) continue;

      const capXML = new DOMParser().parseFromString(contentXML, "application/xml");
      const capNS = "urn:oasis:names:tc:emergency:cap:1.2";

      const getTag = (parent, tag) => parent.getElementsByTagNameNS(capNS, tag)[0]?.textContent || '';
      const info = capXML.getElementsByTagNameNS(capNS, "info")[0];
      if (!info) continue;

      const areaNodes = [...info.getElementsByTagNameNS(capNS, "area")];

      // Extract base CAP fields
      const identifier = getTag(capXML, "identifier");
      const sent = getTag(capXML, "sent");
      const status = getTag(capXML, "status");
      const msgType = getTag(capXML, "msgType");
      const scope = getTag(capXML, "scope");
      const senderName = getTag(info, "senderName");
      const headline = getTag(info, "headline");
      const effective = getTag(info, "effective");
      const expires = getTag(info, "expires");
      const urgency = getTag(info, "urgency");
      const severity = getTag(info, "severity");
      const certainty = getTag(info, "certainty");

      // Check time windows
      const now = new Date();
      const onsetTime = new Date(effective);
      const expiresTime = new Date(expires);
      let alertStatus = "";

      if (now >= onsetTime && now <= expiresTime) {
        alertStatus = "active-now";
      } else if (now < onsetTime) {
        alertStatus = "upcoming";
      } else {
        alertStatus = "expired";
      }

      const isAllowedStatus =
        alertStatus === "active-now" ||
        alertStatus === "upcoming" ||
        (alertStatus === "expired" && SHOW_EXPIRED_ALERTS);

    let intersects = false;
let areaDesc = "";
let matchedAreaNames = [];
const geoCoords = [];

areaNodes.forEach(area => {
  const desc = area.getElementsByTagNameNS(capNS, "areaDesc")[0]?.textContent || '';
  const polyEls = [...area.getElementsByTagNameNS(capNS, "polygon")];

  areaDesc += desc + "; ";

  polyEls.forEach(p => {
    const coords = p.textContent.trim().split(" ").map(pair => {
      const [lat, lon] = pair.split(",").map(Number);
      return [lon, lat];
    });
    geoCoords.push(coords);
  });
});

geoCoords.forEach(coords => {
  const poly = turf.polygon([coords]);

  // Far North
  if (!DISABLE_FAR_NORTH_ALERTS && farNorthGeoJSON && turf.booleanIntersects(poly, farNorthGeoJSON)) {
    intersects = true;
    if (!matchedAreaNames.includes("Far North District")) {
      matchedAreaNames.push("Far North District");
    }
  }

  // Custom Areas
  if (SHOW_CUSTOM_GEOJSON_ALERTS && customGeoAreas.length) {
    const keys = Object.keys(CustomGeoAreas);
    for (let i = 0; i < customGeoAreas.length; i++) {
      const custom = customGeoAreas[i];
      const name = keys[i] || "a custom area";
      if (turf.booleanIntersects(poly, custom)) {
        intersects = true;
        if (!matchedAreaNames.includes(name)) {
          matchedAreaNames.push(name);
        }
      }
    }
  }
});

      const qualifies = intersects && isAllowedStatus;

      const formatNZTime = iso => {
        if (!iso) return '';
        const dt = new Date(iso);
        return dt.toLocaleString("en-NZ", {
          weekday: "long",
          day: "numeric",
          month: "long",
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
          timeZone: "Pacific/Auckland"
        });
      };
      
      matchedAreaNames.sort((a, b) => {
  const iA = AREA_DISPLAY_ORDER.indexOf(a);
  const iB = AREA_DISPLAY_ORDER.indexOf(b);
  return (iA === -1 ? 999 : iA) - (iB === -1 ? 999 : iB); // fallback to end if not found
});


      const alertHTML = `
<div class="alert-card far-north alert-red ${alertStatus}">
  <b>${headline}</b><br>
  ${senderName} has issued an alert that covers parts of   ${formatAreaList(matchedAreaNames)} from ${formatNZTime(effective)}
  to ${formatNZTime(expires)}.<br>
  <b>Urgency:</b> ${urgency} <b>Severity:</b> ${severity}<br>
  <span class="badge alert-cd">Civil Defence</span>
  ${alertStatus === 'upcoming' ? `<span class="badge upcoming-badge">Upcoming</span><br>` : ''}
  ${alertStatus === 'active-now' ? `<span class="badge active-badge">Active Now</span><br>` : ''}
  ${alertStatus === 'expired' ? `<span class="badge expired-badge">Expired</span><br>` : ''}

  <a href="https://www.civildefence.govt.nz/" target="_blank">Visit civildefence.govt.nz for more information</a>
</div>`;

      if (qualifies) {
combinedAlertList.push({ html: alertHTML, status: alertStatus, source: 'cd' }); // in fetchCDAlerts

      } else if (
        SHOW_NON_FAR_NORTH_ALERTS &&
        (alertStatus === "active-now" || alertStatus === "upcoming" || (alertStatus === "expired" && SHOW_EXPIRED_ALERTS))
      ) {
combinedAlertList.push({ html: alertHTML, status: alertStatus, source: 'cd' }); // in fetchCDAlerts

      }
    }

    // Sort and render CD alerts
    const statusOrder = { "active-now": 1, "upcoming": 2, "expired": 3 };
    cdAlertList.sort((a, b) => (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99));

    const floatingEl = document.getElementById("floating-alerts-container");
    const toggleBtn = document.getElementById("toggle-alerts-btn");

    if (cdAlertList.length) {
      floatingEl.innerHTML += cdAlertList.map(a => a.html).join("\n");
      toggleBtn.style.display = "flex";
    }
renderCombinedAlerts();
  } catch (err) {
    console.error("CD Alert fetch failed", err);
  }
}

Promise.all([loadFarNorthGeoJSON(), loadCustomGeoJSONAreas()])
  .then(([farNorth, customAreas]) => {
    farNorthGeoJSON = farNorth;
    customGeoAreas = customAreas;
    return Promise.all([fetchCDAlerts(), fetchAlerts()]);
  })
  .then(renderCombinedAlerts);

 async function loadCustomGeoJSONAreas() {
  const areas = [];

  for (const key in CustomGeoAreas) {
    const entry = CustomGeoAreas[key];

    if (typeof entry === "string") {
      try {
        const url = USE_PROXY_FOR_CUSTOM_GEOJSON ? proxy + encodeURIComponent(entry) : entry;
        const res = await fetch(url);
        const geojson = await res.json();
        if (geojson.type === "FeatureCollection") {
          areas.push(geojson);
        }
      } catch (e) {
        console.warn(`Failed to fetch custom GeoJSON for ${key}:`, e);
      }
    } else if (entry?.type === "FeatureCollection") {
      areas.push(entry);
    }
  }

  return areas;
} 
   
function renderCombinedAlerts() {
  // Order: CD alerts first, then MetService ‚Äî within each group, sort by status
  const statusOrder = { "active-now": 1, "upcoming": 2, "expired": 3 };

  combinedAlertList.sort((a, b) => {
    if (a.source !== b.source) return a.source === 'cd' ? -1 : 1; // CD first
    return (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99);
  });

  const floatingEl = document.getElementById("floating-alerts-container");
  const toggleBtn = document.getElementById("toggle-alerts-btn");

  if (combinedAlertList.length) {
    floatingEl.innerHTML = combinedAlertList.map(a => a.html).join("\n");
    toggleBtn.style.display = "flex";
  } else {
    floatingEl.innerHTML = "";
    toggleBtn.style.display = "none";
  }
}

  function isStillActive(onsetText, expiresText) {
  const now = new Date();
  const onset = onsetText ? new Date(onsetText) : null;
  const expires = expiresText ? new Date(expiresText) : null;

  if (expires && now > expires) return false;
  if (onset && now < onset) return true;
  if (onset && expires) return now >= onset && now <= expires;
  if (expires) return now <= expires;

  return true;
}

  
 function isWithinHourWindow(onsetText, expiresText) {
  const now = new Date();
  const onset = onsetText ? new Date(onsetText) : null;
  const expires = expiresText ? new Date(expiresText) : null;
 
  if (onset && expires) {
    const isActive = now >= onset && now <= expires;
    const startsSoon = onset > now && (onset - now) / 1000 / 3600 <= HOUR_WINDOW;
    return isActive || startsSoon;
  }

  if (onset) {
    const diffHours = (onset - now) / 1000 / 3600;
    const inWindow = diffHours >= 0 && diffHours <= HOUR_WINDOW;
    return inWindow;
  }

  return false;
}

function formatAreaList(areaArray) {
  if (!areaArray || areaArray.length === 0) return "the alert region";
  if (areaArray.length === 1) return areaArray[0];
  if (areaArray.length === 2) return `${areaArray[0]} and ${areaArray[1]}`;
  return `${areaArray.slice(0, -1).join(", ")}, and ${areaArray[areaArray.length - 1]}`;
}

  document.getElementById("toggle-alerts-btn").addEventListener("click", () => {
    const el = document.getElementById("floating-alerts-container");
    el.style.display = (el.style.display === "none" || !el.style.display) ? "block" : "none";
  });
</script>
  
</head>
<body>

  <header>
    <svg class="hero-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M13 2L3 14H12L11 22L21 10H13L13 2Z" fill="white"/>
    </svg>
    <h1>Region warning and alerts</h1>
    <p>Real-time updates, set and forget, no complex setup</p>
  </header>

  <main>
    <section>
      <h2>What this tool offers</h2>
      <p>Visualises emergency alerts, warnings, and region-specific information using geospatial data and modern web technologies. It‚Äôs portable, customisable, and built with real-time decision-making in mind.</p>
      <div class="feature-list">
        <div class="feature">
          <h3>
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path fill="currentColor" d="M1 21h22L12 2 1 21zm13-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
            </svg>
            Real-time alerts
          </h3>
          <p>Instantly surface critical weather and civil defence warnings for specific regions.</p>
        </div>
        <div class="feature">
          <h3>
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path fill="currentColor" d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"/>
            </svg>
            Geospatial mapping
          </h3>
          <p>Alerts are filtered using live polygon checks not just names or guesses.</p>
        </div>
        <div class="feature">
          <h3>
            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path fill="currentColor" d="M7 3v6h10V3h2v6h2v2h-2v4c0 2.21-1.79 4-4 4h-1v4h-2v-4h-1c-2.21 0-4-1.79-4-4v-4H3v-2h2V3h2z"/>
            </svg>
            Easy integration
          </h3>
          <p>Embed the alert viewer anywhere on your homepage, dashboards, or partner sites.</p>
        </div>
      </div>
    </section>

    <section>
      <h2>Live demos coming soon</h2>
      <p>We're preparing demo pages tailored to various districts using archived alerts. Want to be featured or request a setup for your organisation?</p>
      <a href="https://forms.gle/wP68BVjsRVyvMVZi9" class="button">Register your interest</a>
    </section>
<section style="max-width: 900px; margin: 3rem auto; padding: 2rem; background: #ffffff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); font-family: 'Inter', sans-serif;">
  <h2 style="color: #dc3545; font-size: 2rem; margin-bottom: 1rem; text-align: center;">üîç Region Warning and Alerts ‚Äì Key Features</h2>

  <ul style="list-style: none; padding: 0; margin: 0; line-height: 1.6;">
    <li><strong>üõ∞ Real-Time Alert Detection:</strong> Fetches official CAP alerts from trusted sources like MetService and Civil Defence</li>
    <li><strong>üó∫ Geospatial Filtering:</strong> Checks if alerts intersect with pre-defined or custom GeoJSON areas</li>
    <li><strong>üß≠ Custom Map Zones:</strong> Define drawn polygons using Leaflet-based tools; supports local overlays (e.g. iwi areas)</li>
    <li><strong>üß∞ Modular Config:</strong> Enable or disable sources, geo-filters, and display rules with a flexible config</li>
    <li><strong>üßæ Human-Friendly Alert Display:</strong> Translates raw alert data into clear summaries with timing, severity, and source info</li>
    <li><strong>üîÅ Serverless & Lightweight:</strong> Deployable with just HTML + JavaScript, with no backend required</li>
    <li><strong>üß™ Archived Feed Testing:</strong> Swap in archived alert feeds for demonstration or review purposes</li>
    <li><strong>üñº Embeddable UI Options:</strong> Floating widget or targeted div mode, with adaptable styling</li>
    <li><strong>üåê Multi-Organisation Ready:</strong> Reconfigurable for use by other councils, CDEM groups, or partners</li>
  </ul>
</section>

<section>
      <h2>See it in action</h2>
      <p>Press the rain-cloud icon in the botton-right hand corner to see a preview of the tool.</p><p>
    </section>
  </main>

  <footer>
    &copy; 2025 Region Alert Platform - Amorangi Mathews ¬∑ For Civil Defence and Public Safety
  </footer>

</body>
</html>
